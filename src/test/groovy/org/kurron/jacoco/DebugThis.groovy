package org.kurron.jacoco

// use report generated by Gradle - remove DOCTYPE, since it causes errors
def xmlReport = '/home/vagrant/GitHub/jacoco-experiment/build/reports/jacoco/test/jacocoTestReport.xml'
String xmlStr = new File( xmlReport ).text.replace( '<!DOCTYPE report PUBLIC "-//JACOCO//DTD Report 1.0//EN" "report.dtd">', '' )
def xml = new XmlParser( false, false ).parse( new ByteArrayInputStream( xmlStr.bytes ) )

List<String> jacocoExclude = []//'org/kurron/jacoco/UntestedService']
def filtered = xml.package.class.findAll { clazz -> !jacocoExclude.any { clazz.@name.contains( it ) } }
def instructions = filtered.collect{ it.counter }.flatten().findAll{ it.@type == 'INSTRUCTION' }.flatten()
def offenders = []
def missedCoverage = instructions.collect {
    boolean hasCoverage = it.@missed >= it.@covered
    if ( hasCoverage ) { offenders << it.parent().attributes().name }
    hasCoverage
}.any()
println 'Not enough coverage? ' + missedCoverage
println offenders
